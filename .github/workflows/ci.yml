name: CI/CD

on:
  push:
    branches:
      - master

jobs:

  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    - uses: actions-rs/cargo@v1
      with:
        command: test

  deploy:
    if: github.ref_name == 'master'

    runs-on: ubuntu-latest
    needs: [test]
    environment: production
    defaults:
      run:
        working-directory: ./web

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'yarn'
        cache-dependency-path: ./web/yarn.lock
    - run: yarn install --frozen-lockfile
    - run: yarn build
    - name: deploy page
      uses: fangbinwei/aliyun-oss-website-action@v1.3.0
      with:
        accessKeyId: ${{ secrets.ACCESS_KEY_ID }}
        accessKeySecret: ${{ secrets.ACCESS_KEY_SECRET }}
        bucket: splatquery-hk
        endpoint: oss-cn-hongkong.aliyuncs.com
        folder: ./web/dist
